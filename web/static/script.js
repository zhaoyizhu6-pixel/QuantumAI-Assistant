const msgs=document.getElementById('msgs');const input=document.getElementById('input');const sendBtn=document.getElementById('send');const personaSel=document.getElementById('persona');const modeSel=document.getElementById('mode');const alphaEl=document.getElementById('alpha');const betaEl=document.getElementById('beta');const themeBtn=document.getElementById('theme');const clearBtn=document.getElementById('clear');const blochFrame=document.getElementById('blochFrame');function addBubble(t,c){const d=document.createElement('div');d.className='bubble '+c;d.textContent=t;msgs.appendChild(d);msgs.scrollTop=msgs.scrollHeight;} sendBtn.onclick=async()=>{const msg=input.value.trim();if(!msg)return;addBubble(msg,'user');input.value='';const payload={message:msg,persona:personaSel.value,mode:modeSel.value,alpha:parseFloat(alphaEl.value),beta:parseFloat(betaEl.value)};const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});const data=await res.json();addBubble(data.answer,'ai');if(data.gate){blochFrame.contentWindow.postMessage({gate:data.gate,speed:'slow'},'*');} if(data.learn){const teach=prompt('我不太确定，你可以告诉我正确解释吗？');if(teach&&teach.trim()){await fetch('/api/learn',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:msg,answer:teach.trim()})});addBubble('收到，我已经学会了这条新知识！','ai');}}}; input.addEventListener('keydown',(e)=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendBtn.click();}}); themeBtn.onclick=()=>{const b=document.body;if(b.classList.contains('dark')){b.classList.remove('dark');b.classList.add('light');}else{b.classList.remove('light');b.classList.add('dark');}}; clearBtn.onclick=async()=>{await fetch('/api/clear_memory',{method:'POST'});addBubble('（已清空记忆）','ai');}; document.querySelectorAll('.tab').forEach(t=>{t.onclick=()=>{document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));t.classList.add('active');const k=t.dataset.tab;document.getElementById('panel-bloch').classList.toggle('hidden',k!=='bloch');document.getElementById('panel-graph').classList.toggle('hidden',k!=='graph');};});